<% if (user.role === 'issuer' && (!user.institutionSetupCompleted || !user.certificateCreated)) { %>
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-check me-2"></i>Issuer Onboarding Process
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Welcome <%= user.email %>!</strong>
                    <br>
                    Please complete the onboarding process before managing PRC requests.
                </div>

                <div class="row g-3">
                    <!-- Step 1: Create or Join Institution -->
                    <div class="col-md-4">
                        <div class="card h-100 <%= user.institutionSetupCompleted ? 'border-success' : 'border-warning' %> shadow-sm">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <% if (user.institutionSetupCompleted) { %>
                                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                    <% } else { %>
                                        <i class="bi bi-hospital text-warning" style="font-size: 3rem;"></i>
                                    <% } %>
                                </div>
                                <h6 class="card-title">
                                    <span class="badge <%= user.institutionSetupCompleted ? 'bg-success' : 'bg-warning' %> mb-2">
                                        Step 1
                                    </span>
                                </h6>
                                <h5 class="mb-3">Setup Institution</h5>
                                <p class="text-muted small mb-3">
                                    Create a new healthcare institution or join an existing one
                                </p>
                                <% if (user.institutionSetupCompleted) { %>
                                    <button class="btn btn-success btn-sm mb-2" disabled>
                                        <i class="bi bi-check-circle me-1"></i>Completed
                                    </button>
                                    <% if (user.country && user.institutionId) { %>
                                        <div class="mt-2">
                                            <small class="text-muted d-block">Institution:</small>
                                            <small class="badge bg-secondary"><%= user.country %>:<%= user.institutionId %></small>
                                        </div>
                                    <% } %>
                                <% } else if (typeof pendingInstitutionRequest !== 'undefined' && pendingInstitutionRequest) { %>
                                    <!-- Show pending status when request is awaiting approval -->
                                    <div class="alert alert-info mb-2 py-2 px-2">
                                        <i class="bi bi-clock-history me-1"></i>
                                        <strong>Approval Pending</strong>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block mb-1">
                                            <% if (pendingInstitutionRequest.requestType === 'create') { %>
                                                <strong>Creating Institution:</strong><br>
                                                <%= pendingInstitutionRequest.institutionName %> (<%= pendingInstitutionRequest.institutionCountry %>)
                                            <% } else { %>
                                                <strong>Joining Institution:</strong><br>
                                                <% if (pendingInstitutionRequest.institutionId) { %>
                                                    <%= pendingInstitutionRequest.institutionId.name %> (<%= pendingInstitutionRequest.institutionId.country %>)
                                                <% } %>
                                            <% } %>
                                        </small>
                                    </div>
                                    <small class="text-muted d-block">
                                        Submitted: <%= new Date(pendingInstitutionRequest.createdAt).toLocaleDateString() %>
                                    </small>
                                    <div class="mt-2">
                                        <a href="/institution-request/my-requests" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-list-ul me-1"></i>View Status
                                        </a>
                                    </div>
                                <% } else { %>
                                    <div class="btn-group-vertical w-100" role="group">
                                        <a href="/institution-request/create" class="btn btn-warning btn-sm mb-2">
                                            <i class="bi bi-plus-circle me-1"></i>Create Institution
                                        </a>
                                        <a href="/institution-request/join" class="btn btn-outline-warning btn-sm">
                                            <i class="bi bi-box-arrow-in-right me-1"></i>Join Institution
                                        </a>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Note: Admin approval required</small>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Complete Profile -->
                    <div class="col-md-4">
                        <div class="card h-100 <%= user.profileCompleted ? 'border-success' : (user.institutionSetupCompleted ? 'border-warning' : 'border-secondary') %> shadow-sm">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <% if (user.profileCompleted) { %>
                                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                    <% } else if (user.institutionSetupCompleted) { %>
                                        <i class="bi bi-person-circle text-warning" style="font-size: 3rem;"></i>
                                    <% } else { %>
                                        <i class="bi bi-person-circle text-secondary" style="font-size: 3rem;"></i>
                                    <% } %>
                                </div>
                                <h6 class="card-title">
                                    <span class="badge <%= user.profileCompleted ? 'bg-success' : (user.institutionSetupCompleted ? 'bg-warning' : 'bg-secondary') %> mb-2">
                                        Step 2
                                    </span>
                                </h6>
                                <h5 class="mb-3">Complete Profile</h5>
                                <p class="text-muted small mb-3">
                                    Add your contact information and institution establishment date
                                </p>
                                <% if (user.profileCompleted) { %>
                                    <button class="btn btn-success btn-sm" disabled>
                                        <i class="bi bi-check-circle me-1"></i>Completed
                                    </button>
                                <% } else if (user.institutionSetupCompleted) { %>
                                    <a href="/auth/profile" class="btn btn-warning btn-sm">
                                        <i class="bi bi-pencil me-1"></i>Complete Profile
                                    </a>
                                <% } else { %>
                                    <button class="btn btn-secondary btn-sm" disabled>
                                        <i class="bi bi-lock me-1"></i>Complete Step 1 First
                                    </button>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Create Signing Certificate -->
                    <div class="col-md-4">
                        <div class="card h-100 <%= user.certificateCreated ? 'border-success' : ((user.profileCompleted && user.institutionSetupCompleted) ? 'border-warning' : 'border-secondary') %> shadow-sm">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <% if (user.certificateCreated) { %>
                                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                    <% } else if (user.profileCompleted && user.institutionSetupCompleted) { %>
                                        <i class="bi bi-key text-warning" style="font-size: 3rem;"></i>
                                    <% } else { %>
                                        <i class="bi bi-key text-secondary" style="font-size: 3rem;"></i>
                                    <% } %>
                                </div>
                                <h6 class="card-title">
                                    <span class="badge <%= user.certificateCreated ? 'bg-success' : ((user.profileCompleted && user.institutionSetupCompleted) ? 'bg-warning' : 'bg-secondary') %> mb-2">
                                        Step 3
                                    </span>
                                </h6>
                                <h5 class="mb-3">Create Certificate</h5>
                                <p class="text-muted small mb-3">
                                    Generate a signing certificate (RSA or EC P-256) for PRC documents
                                </p>
                                <% if (user.certificateCreated) { %>
                                    <button class="btn btn-success btn-sm mb-2" disabled>
                                        <i class="bi bi-check-circle me-1"></i>Completed
                                    </button>
                                    <div class="mt-2">
                                        <a href="/certificates" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-key me-1"></i>View Certificates
                                        </a>
                                    </div>
                                <% } else if (user.profileCompleted && user.institutionSetupCompleted) { %>
                                    <a href="/certificates/create" class="btn btn-warning btn-sm">
                                        <i class="bi bi-key me-1"></i>Create Certificate
                                    </a>
                                    <div class="mt-2">
                                        <small class="text-muted">RSA or EC P-256</small>
                                    </div>
                                <% } else { %>
                                    <button class="btn btn-secondary btn-sm" disabled>
                                        <i class="bi bi-lock me-1"></i>Complete Previous Steps
                                    </button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3 text-center">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        After completing all steps, you'll be able to approve PRC requests from citizens and manage certificates for your institution.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
<% } %>
