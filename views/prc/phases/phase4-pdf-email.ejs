<div class="card">
    <div class="card-header">
        <i class="bi bi-file-earmark-pdf me-2"></i>
        Phase 4: PDF Generation & Email Distribution
    </div>
    <div class="card-body">
        <p class="text-muted mb-4">
            Generate the final PRC PDF document according to Decision S2 specifications and
            optionally distribute it via email to the card holder or authorized recipients.
        </p>

        <div class="row">
            <!-- Document Preview -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <i class="bi bi-file-text me-2"></i>
                        Document Preview
                    </div>
                    <div class="card-body">
                        <% if (typeof prcSession !== 'undefined' && prcSession.formData && prcSession.qrCode) { %>
                            <div class="document-preview">
                                <div class="preview-header">
                                    <h6 class="text-center mb-3">
                                        <strong>PROVISIONAL REPLACEMENT CERTIFICATE</strong><br>
                                        <small>OF THE EUROPEAN HEALTH INSURANCE CARD</small>
                                    </h6>
                                </div>

                                <div class="preview-content">
                                    <div class="section mb-3">
                                        <div class="section-header">Issuing Member State</div>
                                        <p class="mb-1">2. <%= prcSession.formData.ic %></p>
                                    </div>

                                    <div class="section mb-3">
                                        <div class="section-header">Card holder-related information</div>
                                        <p class="mb-1">3. Name: <%= prcSession.formData.fn %></p>
                                        <p class="mb-1">4. Given name(s): <%= prcSession.formData.gn %></p>
                                        <p class="mb-1">5. Date of birth: <%= prcSession.formData.dob %></p>
                                        <p class="mb-1">6. Personal identification number: <%= prcSession.formData.hi %></p>
                                    </div>

                                    <div class="section mb-3">
                                        <div class="section-header">Competent institution-related information</div>
                                        <p class="mb-1">7. Identification number of the institution:</p>
                                        <p class="ms-3 mb-1"><%= prcSession.formData.ii %> - <%= prcSession.formData.in %></p>
                                    </div>

                                    <div class="section mb-3">
                                        <div class="section-header">Certificate validity period</div>
                                        <p class="mb-1">(a) From: <%= prcSession.formData.sd %></p>
                                        <p class="mb-1">(b) To: <%= prcSession.formData.ed %></p>
                                    </div>

                                    <div class="section mb-3">
                                        <div class="section-header">Certificate delivery date</div>
                                        <p class="mb-1">(c) <%= prcSession.formData.di %></p>
                                    </div>

                                    <div class="text-center mt-4">
                                        <div class="qr-preview">
                                            <% if (prcSession.qrCode.qrCodeImage) { %>
                                                <img src="<%= prcSession.qrCode.qrCodeImage %>" alt="QR Code"
                                                     style="max-width: 120px; border: 1px solid #ddd;">
                                            <% } else { %>
                                                <div class="qr-placeholder">QR Code</div>
                                            <% } %>
                                        </div>
                                        <small class="text-muted">Signature and/or stamp of the institution</small>
                                    </div>
                                </div>
                            </div>
                        <% } else { %>
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                                <p class="mt-2">Incomplete data. Please complete previous phases first.</p>
                                <a href="/prc/generate?phase=1" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-arrow-left me-1"></i>Start Over
                                </a>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- PDF Generation & Email -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <i class="bi bi-gear me-2"></i>
                        Generation & Distribution
                    </div>
                    <div class="card-body">
                        <!-- PDF Generation -->
                        <div class="mb-4">
                            <h6><i class="bi bi-file-earmark-pdf me-2"></i>PDF Generation</h6>
                            <p class="text-muted small mb-3">
                                Generate the official PRC document in PDF format according to eEHIC specifications.
                            </p>

                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary" id="generatePDF"
                                        <%= (typeof prcSession === 'undefined' || !prcSession.formData || !prcSession.qrCode) ? 'disabled' : '' %>>
                                    <span class="btn-text">
                                        <i class="bi bi-file-earmark-pdf me-2"></i>Generate PDF
                                    </span>
                                    <span class="loading-spinner">
                                        <i class="bi bi-arrow-clockwise spin me-2"></i>Generating...
                                    </span>
                                </button>

                                <button type="button" class="btn btn-outline-secondary" id="previewPDF" disabled>
                                    <i class="bi bi-eye me-2"></i>Preview PDF
                                </button>

                                <button type="button" class="btn btn-outline-success" id="downloadPDF" disabled>
                                    <i class="bi bi-download me-2"></i>Download PDF
                                </button>
                            </div>
                        </div>

                        <hr>

                        <!-- Email Distribution -->
                        <div class="mb-4">
                            <h6><i class="bi bi-envelope me-2"></i>Email Distribution</h6>
                            <p class="text-muted small mb-3">
                                Send the PRC document via email to the card holder or authorized recipients.
                            </p>

                            <form id="emailForm">
                                <div class="form-floating mb-3">
                                    <input type="email" class="form-control" id="recipientEmail" name="recipientEmail"
                                           placeholder="Recipient email address" required>
                                    <label for="recipientEmail">Recipient Email Address *</label>
                                </div>

                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="emailSubject" name="emailSubject"
                                           placeholder="Email subject"
                                           value="Your PRC Document - <%= typeof prcSession !== 'undefined' && prcSession.formData ? prcSession.formData.gn + ' ' + prcSession.formData.fn : '' %>">
                                    <label for="emailSubject">Email Subject</label>
                                </div>

                                <div class="form-floating mb-3">
                                    <textarea class="form-control" id="emailMessage" name="emailMessage"
                                              placeholder="Additional message (optional)" rows="3" style="height: 100px;"></textarea>
                                    <label for="emailMessage">Additional Message (Optional)</label>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="includeQR" name="includeQR" checked>
                                    <label class="form-check-label" for="includeQR">
                                        Include QR code image as attachment
                                    </label>
                                </div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success" disabled id="sendEmail">
                                        <span class="btn-text">
                                            <i class="bi bi-envelope me-2"></i>Send Email
                                        </span>
                                        <span class="loading-spinner">
                                            <i class="bi bi-arrow-clockwise spin me-2"></i>Sending...
                                        </span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generation Status -->
        <div id="generationStatus" class="mt-4 d-none">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-activity me-2"></i>
                    Generation Status
                </div>
                <div class="card-body">
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" id="statusProgress" style="width: 0%"></div>
                    </div>
                    <div id="statusLog" class="font-monospace small" style="max-height: 150px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- Completion Summary -->
        <div id="completionSummary" class="mt-4 d-none">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-check-circle me-2"></i>
                    PRC Generation Complete
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>Successfully Generated PRC Document</h5>
                            <p class="mb-3">
                                The Provisional Replacement Certificate has been generated according to eEHIC
                                specifications and is ready for use.
                            </p>

                            <dl class="row">
                                <dt class="col-sm-3">Document ID:</dt>
                                <dd class="col-sm-9" id="documentId">-</dd>

                                <dt class="col-sm-3">Generated:</dt>
                                <dd class="col-sm-9" id="generationTime">-</dd>

                                <dt class="col-sm-3">Valid Period:</dt>
                                <dd class="col-sm-9" id="validityPeriod">-</dd>

                                <dt class="col-sm-3">File Size:</dt>
                                <dd class="col-sm-9" id="fileSize">-</dd>

                                <dt class="col-sm-3">Email Status:</dt>
                                <dd class="col-sm-9" id="emailStatus">Not sent</dd>
                            </dl>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="mb-3">
                                <i class="bi bi-patch-check-fill text-success" style="font-size: 3rem;"></i>
                            </div>
                            <div class="d-grid gap-2">
                                <a href="/prc/dashboard" class="btn btn-primary">
                                    <i class="bi bi-house me-2"></i>Return to Dashboard
                                </a>
                                <button type="button" class="btn btn-outline-primary" id="generateAnother">
                                    <i class="bi bi-plus-circle me-2"></i>Generate Another PRC
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.document-preview {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    background: white;
    font-size: 0.875rem;
    line-height: 1.4;
}

.preview-header {
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 0.75rem;
    margin-bottom: 1rem;
}

.section {
    border-bottom: 1px solid #f1f3f4;
    padding-bottom: 0.5rem;
}

.section-header {
    background-color: #f8f9fa;
    padding: 0.25rem 0.5rem;
    font-weight: 600;
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 0.25rem;
}

.qr-preview img {
    border-radius: 0.25rem;
}

.qr-placeholder {
    width: 120px;
    height: 120px;
    border: 2px dashed #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    color: #6c757d;
    font-size: 0.875rem;
}

@media (max-width: 768px) {
    .document-preview {
        padding: 0.75rem;
        font-size: 0.8rem;
    }

    .section-header {
        font-size: 0.7rem;
    }
}
</style>

<script>
// Phase 4 specific validation
window.validatePhase4 = function() {
    // Phase 4 is complete when PDF is generated
    return document.getElementById('downloadPDF').disabled === false;
};

let pdfGenerated = false;
let pdfUrl = '';
let prcDocumentId = '';

// Log status message
function logStatus(message) {
    const log = document.getElementById('statusLog');
    if (log) {
        const timestamp = new Date().toLocaleTimeString();
        log.innerHTML += `[${timestamp}] ${message}\n`;
        log.scrollTop = log.scrollHeight;
    }
}

// Update progress
function updateProgress(percentage, message) {
    const progressBar = document.getElementById('statusProgress');
    if (progressBar) {
        progressBar.style.width = percentage + '%';
        progressBar.textContent = Math.round(percentage) + '%';
    }
    if (message) logStatus(message);
}

// Generate PDF
document.getElementById('generatePDF').addEventListener('click', function() {
    setLoading(this, true);
    document.getElementById('generationStatus').classList.remove('d-none');
    document.getElementById('statusLog').innerHTML = '';

    updateProgress(10, 'Starting PDF generation...');

    fetch('/prc/phase4/generate-pdf', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        updateProgress(50, 'Processing server response...');
        return response.json();
    })
    .then(result => {
        setLoading(this, false);

        if (result.success) {
            updateProgress(100, 'PDF generation completed successfully!');

            // Enable preview and download buttons
            document.getElementById('previewPDF').disabled = false;
            document.getElementById('downloadPDF').disabled = false;
            document.getElementById('sendEmail').disabled = false;

            // Store PDF info
            pdfGenerated = true;
            pdfUrl = result.pdfUrl;
            prcDocumentId = result.documentId;

            logStatus(`PDF generated: ${result.fileSize} bytes`);
            logStatus(`Document ID: ${result.documentId}`);

            // Update completion summary
            updateCompletionSummary(result);

            // Update next button
            updateNextButton();
        } else {
            updateProgress(0, `PDF generation failed: ${result.error}`);
            alert('PDF generation failed: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(error => {
        setLoading(this, false);
        updateProgress(0, `Network error: ${error.message}`);
        console.error('PDF generation error:', error);
        alert('An error occurred while generating PDF. Please try again.');
    });
});

// Preview PDF
document.getElementById('previewPDF').addEventListener('click', function() {
    if (pdfUrl) {
        window.open(pdfUrl, '_blank');
    } else {
        alert('No PDF available. Please generate PDF first.');
    }
});

// Download PDF
document.getElementById('downloadPDF').addEventListener('click', function() {
    if (pdfUrl) {
        const link = document.createElement('a');
        link.href = pdfUrl;
        link.download = `PRC_${prcDocumentId}_${new Date().toISOString().split('T')[0]}.pdf`;
        link.click();
    } else {
        alert('No PDF available. Please generate PDF first.');
    }
});

// Email form submission
document.getElementById('emailForm').addEventListener('submit', function(e) {
    e.preventDefault();

    if (!pdfGenerated) {
        alert('Please generate PDF first before sending email.');
        return;
    }

    const formData = new FormData(this);
    const emailData = Object.fromEntries(formData);

    const submitBtn = document.getElementById('sendEmail');
    setLoading(submitBtn, true);

    updateProgress(10, 'Preparing email...');

    fetch('/prc/phase4/send-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            recipientEmail: emailData.recipientEmail,
            subject: emailData.emailSubject,
            message: emailData.emailMessage,
            includeQR: emailData.includeQR === 'on',
            documentId: prcDocumentId
        })
    })
    .then(response => {
        updateProgress(50, 'Sending email...');
        return response.json();
    })
    .then(result => {
        setLoading(submitBtn, false);

        if (result.success) {
            updateProgress(100, `Email sent successfully to ${emailData.recipientEmail}`);
            document.getElementById('emailStatus').textContent = `Sent to ${emailData.recipientEmail}`;

            alert('Email sent successfully!\n\n' +
                  'Recipient: ' + emailData.recipientEmail + '\n' +
                  'Message ID: ' + (result.messageId || 'N/A') +
                  (result.previewUrl ? '\n\nPreview: ' + result.previewUrl : ''));

            // Show completion summary
            document.getElementById('completionSummary').classList.remove('d-none');
        } else {
            updateProgress(0, `Email sending failed: ${result.error}`);
            alert('Email sending failed: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(error => {
        setLoading(submitBtn, false);
        updateProgress(0, `Email error: ${error.message}`);
        console.error('Email sending error:', error);
        alert('An error occurred while sending email. Please try again.');
    });
});

// Update completion summary
function updateCompletionSummary(pdfResult) {
    const formData = <%= JSON.stringify(typeof prcSession !== 'undefined' ? prcSession.formData || {} : {}) %>;

    document.getElementById('documentId').textContent = pdfResult.documentId;
    document.getElementById('generationTime').textContent = new Date().toLocaleString();
    document.getElementById('validityPeriod').textContent = `${formData.sd} to ${formData.ed}`;
    document.getElementById('fileSize').textContent = formatFileSize(pdfResult.fileSize);
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Generate another PRC
document.getElementById('generateAnother').addEventListener('click', function() {
    if (confirm('This will start a new PRC generation process. Continue?')) {
        // Clear session and start over
        fetch('/prc/clear-session', { method: 'POST' })
            .then(() => {
                window.location.href = '/prc/generate?phase=1';
            })
            .catch(() => {
                window.location.href = '/prc/generate?phase=1';
            });
    }
});

// Auto-fill recipient email with card holder data if available
document.addEventListener('DOMContentLoaded', function() {
    // If PDF already generated, enable buttons
    <% if (typeof prcSession !== 'undefined' && prcSession.pdfGenerated) { %>
        pdfGenerated = true;
        pdfUrl = '<%= prcSession.pdfUrl || "" %>';
        prcDocumentId = '<%= prcSession.documentId || "" %>';

        document.getElementById('previewPDF').disabled = false;
        document.getElementById('downloadPDF').disabled = false;
        document.getElementById('sendEmail').disabled = false;

        // Show completion summary
        const pdfResult = {
            documentId: prcDocumentId,
            fileSize: <%= prcSession.fileSize || 0 %>
        };
        updateCompletionSummary(pdfResult);
        document.getElementById('completionSummary').classList.remove('d-none');
    <% } %>

    updateNextButton();
});
</script>